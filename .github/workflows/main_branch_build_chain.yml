name: Main Build and Push
on:
  push:
    branches:
      - main

jobs:
  generate-build-number:
    runs-on: ubuntu-latest
    name: Create next build number

    # Major Release Version
    env:
      MAJOR_VERSION: "0"

    # Lots of useful bits of information to use here
    # env:
    #   GITHUB_CONTEXT: ${{ toJson(github) }}

    outputs:
      version: ${{ steps.buildversion.outputs.version}}

    steps:
      - name: Generate build number
        id: buildnumber
        uses: einaregilsson/build-number@v3
        with:
          token: ${{secrets.github_token}}

      - name: Set Build Version
        id: buildversion
        run: |
          rawVersion="${{ env.MAJOR_VERSION }}.${{ steps.buildnumber.outputs.build_number }}"
          echo ${rawVersion}
          echo ::set-output name=version::$(echo ${rawVersion} | tr "/" "-")

  test-and-build-server:
    name: Server
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [generate-build-number]

    steps:
      - name: Setup dotnet
        uses: actions/setup-dotnet@v2
        with:
          dotnet-version: 6.x.x

      - name: What I think the version number is
        run: |
          echo ==========================
          echo ${{ needs.generate-build-number.outputs.version }}
          echo ==========================

      - name: Checkout
        uses: actions/checkout@v3

      - name: Start Docker environment
        run: docker compose -f ./docker-compose.ci.yml up -d

      - name: Nuke Build üèó
        id: build
        shell: bash
        run: |
          chmod 777 ./build.ci.sh
          ./build.ci.sh
        env:
          Version: ${{ needs.generate-build-number.outputs.version }}

      - name: Install Octopus CLI üêô
        uses: OctopusDeploy/install-octopus-cli-action@v1
        with:
          version: latest

      - name: Push a package to Octopus Deploy üêô
        uses: OctopusDeploy/push-package-action@v2
        env:
          OCTOPUS_API_KEY: ${{ secrets.OCTOPUS_DEPLOY_API_KEY }}
          OCTOPUS_HOST: ${{ secrets.OCTOPUS_DEPLOY_URL }}
          OCTOPUS_SPACE: "Spaces-2"
        with:
          packages: palavyr-server.${{ needs.generate-build-number.outputs.version }}.zip

      - uses: mr-smithers-excellent/docker-build-push@v5
        name: Build & push development Docker image
        with:
          image: palavyr/palavyr-server
          tags: development-latest, ${{ needs.generate-build-number.outputs.version }}
          registry: ${{ secrets.ECR_REGISTRY }}
          dockerfile: ./server/Dockerfile
        env:
          # for pushing to ECR
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ECR_CONTROL_Access_Key_Id }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_ECR_CONTROL_Secret_Key_Id }}

          # For Palavyr Server
          Palavyr_AWS__AccessKey: ${{secrets.Palavyr_AWS__AccessKey}}
          Palavyr_AWS__SecretKey: ${{secrets.Palavyr_AWS__SecretKey}}
          Palavyr_ConnectionString: ${{secrets.Palavyr_ConnectionString}}
          Palavyr_JWT__SecretKey: ${{secrets.Palavyr_JWT__SecretKey}}
          Palavyr_STRIPE__SecretKey: ${{secrets.Palavyr_STRIPE__SecretKey}}
          Palavyr_AWS__UserDataBucket: palavyr-user-data-development
          Palavyr_AWS__AwsS3ServiceUrl: http://localhost:4566
          Palavyr_AWS__AwsSESServiceUrl: http://localhost:4566
          Palavyr_AWS__Region: "us-east-1"
          Palavyr_Environment: "development"
          Palavyr_AWS__PdfUrl: http://localhost:5603/pdf

  build-frontend:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    name: Frontend
    needs: [generate-build-number]

    steps:
      - name: Set up node
        uses: actions/setup-node@v3
        with:
          node-version: 12

      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Move into ui dir and install
        run: |
          cd ./ui
          npm ci

      - name: Move into ui dir and Build
        run: |
          cd ./ui
          npm run build

      - name: Move into ui dir and Zip the distribution
        run: |
          cd ./ui
          zip -r palavyr-frontend.${{ needs.generate-build-number.outputs.version }}.zip ./dist-frontend
          mv palavyr-frontend.${{ needs.generate-build-number.outputs.version }}.zip ${{ github.workspace }}

      - name: Install Octopus CLI üêô
        uses: OctopusDeploy/install-octopus-cli-action@v1
        with:
          version: latest
      - name: Push a package to Octopus Deploy üêô
        uses: OctopusDeploy/push-package-action@v2
        env:
          OCTOPUS_API_KEY: ${{ secrets.OCTOPUS_DEPLOY_API_KEY }}
          OCTOPUS_HOST: ${{ secrets.OCTOPUS_DEPLOY_URL }}
          OCTOPUS_SPACE: "Spaces-2"
        with:
          packages: palavyr-frontend.${{ needs.generate-build-number.outputs.version }}.zip

      - uses: mr-smithers-excellent/docker-build-push@v5
        name: Build & push Docker image
        with:
          image: palavyr/palavyr-frontend
          tags: development-latest, ${{ needs.generate-build-number.outputs.version }}
          dockerfile: ./ui/docker-frontend/Dockerfile
          registry: ${{ secrets.ECR_REGISTRY }}
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ECR_CONTROL_Access_Key_Id }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_ECR_CONTROL_Secret_Key_Id }}

  build-widget:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    name: Widget
    needs: [generate-build-number]

    steps:
      - name: Set up node
        uses: actions/setup-node@v3
        with:
          node-version: 12

      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Move into ui dir and install
        run: |
          cd ./ui
          npm ci

      - name: Move into ui dir and Build
        run: |
          cd ./ui
          npm run build-widget

      - name: Move into ui dir and Zip the distribution
        run: |
          cd ./ui
          ls -lath
          zip -r palavyr-widget.${{ needs.generate-build-number.outputs.version }}.zip ./dist-widget
          mv palavyr-widget.${{ needs.generate-build-number.outputs.version }}.zip ${{ github.workspace }}

      - name: Install Octopus CLI üêô
        uses: OctopusDeploy/install-octopus-cli-action@v1
        with:
          version: latest

      - name: Push a package to Octopus Deploy üêô
        uses: OctopusDeploy/push-package-action@v2
        env:
          OCTOPUS_API_KEY: ${{ secrets.OCTOPUS_DEPLOY_API_KEY }}
          OCTOPUS_HOST: ${{ secrets.OCTOPUS_DEPLOY_URL }}
          OCTOPUS_SPACE: "Spaces-2"
        with:
          packages: palavyr-widget.${{ needs.generate-build-number.outputs.version }}.zip

      - uses: mr-smithers-excellent/docker-build-push@v5
        name: Build & push to Docker
        with:
          image: palavyr/palavyr-widget
          tags: development-latest, ${{ needs.generate-build-number.outputs.version }}
          dockerfile: ./ui/docker-widget/Dockerfile
          registry: ${{ secrets.ECR_REGISTRY }}
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ECR_CONTROL_Access_Key_Id }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_ECR_CONTROL_Secret_Key_Id }}

  build-pdf-server:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    name: Build pdf-server for ci
    needs: [generate-build-number]

    steps:
      - name: Set up node
        uses: actions/setup-node@v3
        with:
          node-version: 12

      - name: Checkout repo
        uses: actions/checkout@v3

      - uses: mr-smithers-excellent/docker-build-push@v5
        name: Build & push to Docker
        with:
          image: palavyr/palavyr-pdf-server
          tags: development-latest, ${{ needs.generate-build-number.outputs.version }}
          dockerfile: ./pdf/Dockerfile.ci
          registry: ${{ secrets.ECR_REGISTRY }}
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ECR_CONTROL_Access_Key_Id }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_ECR_CONTROL_Secret_Key_Id }}

  build-pdf-server-lambda:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    name: Build pdf-server for lambda
    needs: [generate-build-number]

    steps:
      - name: Set up node
        uses: actions/setup-node@v3
        with:
          node-version: 12

      - name: Checkout repo
        uses: actions/checkout@v3

      - uses: mr-smithers-excellent/docker-build-push@v5
        name: Build & push to Docker
        with:
          image: palavyr/palavyr-pdf-server-lambda
          tags: development-latest, ${{ needs.generate-build-number.outputs.version }}
          dockerfile: ./pdf/Dockerfile.lambda
          registry: ${{ secrets.ECR_REGISTRY }}
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ECR_CONTROL_Access_Key_Id }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_ECR_CONTROL_Secret_Key_Id }}

  create-release:
    runs-on: ubuntu-latest
    needs:
      [test-and-build-server, build-frontend, build-widget, build-pdf-server]
    steps:
      - name: Install Octopus CLI üêô
        uses: OctopusDeploy/install-octopus-cli-action@v1
        with:
          version: latest

      - name: Create a release in Octopus Deploy üêô
        uses: OctopusDeploy/create-release-action@v2
        env:
          OCTOPUS_API_KEY: ${{ secrets.OCTOPUS_DEPLOY_API_KEY  }}
          OCTOPUS_HOST: ${{ secrets.OCTOPUS_DEPLOY_URL }}
          OCTOPUS_SPACE: "Spaces-2"
        with:
          project: "Palavyr"
